package results;

import documento.DocModel;
import documento.DocRecord;
import java.awt.Component;
import java.io.File;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;
import javax.swing.JRadioButton;
import main.Controller;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.text.JTextComponent;
import main.Utils;
import widgets.SearchableComboBox;

public class EcuapassView extends JScrollPane {
	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
  // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
  private void initComponents() {
  }// </editor-fold>//GEN-END:initComponents


  // Variables declaration - do not modify//GEN-BEGIN:variables
  // End of variables declaration//GEN-END:variables

	public Controller controller;
	public DocRecord record;
	public EcuapassPanel ecuapassPanel;
	public String resourcesDir;

	public EcuapassView () {
		initComponents ();
	}

	public void setController (Controller controller) {
		this.controller = controller;
	}

	// Show document record to panel's text fields
	public void showRecord () {
		Object[] mainKeys = record.getMainKeysSorted ().toArray ();
		Component[] fields = ecuapassPanel.getComponents ();

		for (int i = 0; i < mainKeys.length; i++) {
			String key = (String) mainKeys[i];
			String value = (String) record.mainFields.get (key);
			Component cmp = fields[i];
			String confidence = "";
			if (value.equals (""))
				continue;
			else if (value.contains ("||")) { // Check for confidence extraction
				String[] parts = value.split ("\\|\\|");
				confidence = parts[1];
				value = parts[0];
				//record.mainFields.replace (k, value);
				if (confidence.equals ("LOW"))
					cmp.setBackground (Utils.LOW_RED);
				else if (confidence.equals ("MID"))
					cmp.setBackground (Utils.MID_YELLOW);
				else if (confidence.equals ("HIGHT"))
					cmp.setBackground (Utils.HIGH_GREEN);
				else
					System.out.println (">>> ALERTA: Nivel de confidencia no conocido: " + confidence);
			}

			if (cmp instanceof JTextComponent) {
				JTextComponent textComponent = (JTextComponent) cmp;
				textComponent.setText (value);
			} else if (cmp instanceof JScrollPane) {
				JTextArea textComponent = (JTextArea) ((JScrollPane) cmp).getViewport ().getView ();
				textComponent.setText (value);
			} else if (cmp instanceof SearchableComboBox) {
				SearchableComboBox comboBox = (SearchableComboBox) cmp;
				comboBox.selectItemFromSubstring (value);
			}else if (cmp instanceof JRadioButton) {
				JRadioButton rb = (JRadioButton) cmp;
				rb.doClick ();
			} else
				System.out.println (">>> NOT JTextComp: " + cmp.getClass ());
		}
	}
	
	// After user updates ECUAPASS form
	// Update record values from text in components
	public DocRecord updateRecord () {
		Object[] mainKeys = record.getMainKeysSorted ().toArray ();
		Component[] fields = ecuapassPanel.getComponents ();

		for (int i = 0; i < mainKeys.length; i++) {
			String key = (String) mainKeys[i];
			Component cmp = fields[i];

			if (cmp instanceof JTextComponent) {
				JTextComponent textComponent = (JTextComponent) cmp;
				String text = textComponent.getText ();
				record.update (key, text);
			} else if (cmp instanceof JScrollPane) {
				JTextArea textComponent = (JTextArea) ((JScrollPane) cmp).getViewport ().getView ();
				String text = textComponent.getText ();
				record.update (key, text);
			} else if (cmp instanceof SearchableComboBox) {
				SearchableComboBox comboBox = (SearchableComboBox) cmp;
				String textAll = (String) comboBox.getSelectedItem ();
				String text = "";
				if (textAll.contains ("--SelecciÃ³n--") == false)
					text = textAll.split ("\\s+", 2)[1];          // Ecuapass data stasts with [###]

				record.update (key, text);
			} else
				System.out.println (">>> NOT JTextComp: " + cmp.getClass ());
		}
		return record;
	}

	public void setRecord (DocRecord record) {
		this.record = record;
	}

	public DocRecord getRecord () {
		return (record);
	}

	// For idependent combo box
	public SearchableComboBox createComboBox (String filename) {
		String resourcesFile = Paths.get (DocModel.temporalPath, "resources", this.resourcesDir, filename + ".txt").toString ();
		String[] items = Utils.readDataFromFile (resourcesFile);
		SearchableComboBox comboBox = new SearchableComboBox (items);
		return (comboBox);
	}

	// For dependent combo box (e.g. "ciudades" depends of "paises")
	// Loads all dependent files (e.g. "ciudades" for each "pais")
	public SearchableComboBox createComboBox (String filename, SearchableComboBox parentComboBox) {
		Map<String, String[]> subItemsMap = new HashMap<> ();
		String childName = filename.split ("_")[1];
		String[] rootItems = null;
		if (childName.equals ("ciudades"))
			rootItems = new String[]{"COLOMBIA", "ECUADOR", "PERU", "derivado"};
		else if (childName.equals ("depositos"))
			rootItems = new String[]{"QUITO", "TULCAN", "HUAQUILLAS", "HUAQUILLAS", "LOJA", "CEBAF", "derivado"};
		else if (childName.equals ("aduanas"))
			rootItems = new String[]{"COLOMBIA", "ECUADOR", "PERU", "derivado"};
		else
			System.out.println (">>> ALERTA: Tipo de items de ComboBox desconocido:" + childName);

		if (rootItems != null)
			for (String rootItem : rootItems) {
				String itemFilename = rootItem.contains ("derivado") ? "derivado" : childName + "_" + rootItem.toLowerCase ();
				String resourcesFile = Paths.get (DocModel.temporalPath, "resources", this.resourcesDir, itemFilename + ".txt").toString ();
				String[] items = Utils.readDataFromFile (resourcesFile);
				// String[] items = Utils.readDataResourceFromFile (this, this.resourcesDir + itemFilename + ".txt");
				subItemsMap.put (rootItem, items);
			}
		String resourcesFile = Paths.get (DocModel.temporalPath, "resources", this.resourcesDir, "derivado.txt").toString ();
		String[] items = Utils.readDataFromFile (resourcesFile);
		SearchableComboBox comboBox = new SearchableComboBox (items, parentComboBox, subItemsMap);
		return (comboBox);
	}
}